<!DOCTYPE html>
<html lang="ja">
<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=0.65,minimum-scale=0.65, maximum-scale=0.65">
		<title><%= content_for?(:title) ? yield(:title) : "FocusMate" %></title>
		<%= csrf_meta_tags %>

		<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
		<!--[if lt IE 9]>
			<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.1/html5shiv.js" type="text/javascript"></script>
		<![endif]-->

		<%= stylesheet_link_tag "application", :media => "all" %>

		<!-- For third-generation iPad with high-resolution Retina display: -->
		<!-- Size should be 144 x 144 pixels -->
		<%= favicon_link_tag 'apple-touch-icon-144x144-precomposed.png', :rel => 'apple-touch-icon-precomposed', :type => 'image/png', :sizes => '144x144' %>

		<!-- For iPhone with high-resolution Retina display: -->
		<!-- Size should be 114 x 114 pixels -->
		<%= favicon_link_tag 'apple-touch-icon-114x114-precomposed.png', :rel => 'apple-touch-icon-precomposed', :type => 'image/png', :sizes => '114x114' %>

		<!-- For first- and second-generation iPad: -->
		<!-- Size should be 72 x 72 pixels -->
		<%= favicon_link_tag 'apple-touch-icon-72x72-precomposed.png', :rel => 'apple-touch-icon-precomposed', :type => 'image/png', :sizes => '72x72' %>

		<!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
		<!-- Size should be 57 x 57 pixels -->
		<%= favicon_link_tag 'apple-touch-icon-precomposed.png', :rel => 'apple-touch-icon-precomposed', :type => 'image/png' %>

		<!-- For all other devices -->
		<!-- Size should be 32 x 32 pixels -->
		<%= favicon_link_tag 'favicon.ico', :rel => 'shortcut icon' %>

		<%= javascript_include_tag "application" %>
	</head>
	<body>
		<%= render '/layouts/navbar' %>
		<div class="container">
			<div class="row">
				<div class="col-md-2 hidden-sm hidden-xs">
					<%= image_tag(current_user.image, :size => "37x37", :alt => "アイコン") %>
					<%= current_user.name %>さん</br>
				</div>
				<div class="col-md-6 col-sm-8 col-xs-12" id="main-column">
<!--					 <%= bootstrap_flash %> -->
					<%= yield %>
				</div>
				<div class="col-md-3 col-sm-4 hidden-xs">
					<div class="sidebar-nav right-sidebar">
						<h4>メイト一覧</h4>
						<table class="table table-bordered table-hover ">
							<tbody>
								<% if @user_list %>
									<% @user_list.each do |user_list| %>
										<tr class="active">
											<td><%= image_tag(user_list.image, :size => "28x28", :alt => "アイコン")%><%= link_to user_list.name,:controller =>"actions",:action =>"show",:id =>user_list.id %></td>
										</tr>
									<% end %>
								<% end %>
							</tbody>
						</table>
					</div>
				</div>
			</div><!--/row-->
		</div> <!-- /container -->
	</body>
</html>
<script type="text/javascript">
//褒めるの日付フォーム部をカレンダーにする+時刻フォームを操作しやすくする
$(function () {
	$('#action_date').datepicker({
		format:"yyyy/mm/dd",
		language:"ja",
		autoclose: true,
		startDate: "-1m",
		endDate:Date(),
		todayHighlight : true,
	});
	//フォームに今日の日付を入れる
	$("#action_date").val(new DateFormat("yyyy/MM/dd").format(new Date()));
	//日付フォームにフォーカスがあたった時、カレンダーを前面に出す
	$('#action_date').on('show', function(){
		$("div.datepicker.dropdown-menu").css("z-index","10000");
	});

	//カレンダーでの日付選択が行われたとき、timepickerを発動
	$('#action_date').on('changeDate', function(){
		$('#action_time').timepicker('showWidget');
	});

	$('#action_time').timepicker({
		minuteStep:10,
		showMeridian:false
	});
	//時刻フォームにフォーカスがあたった時、cssを適切に設定し直す
	$('#action_time').on('show.timepicker', function(){
		$(".bootstrap-timepicker-widget").css("z-index","10000");
		$(".bootstrap-timepicker-hour").removeClass("form-control");
		$(".bootstrap-timepicker-minute").removeClass("form-control");
		$(".bootstrap-timepicker-hour").css("border","none");
		$(".bootstrap-timepicker-minute").css("border","none");
		$(".bootstrap-timepicker-widget table tbody").append('<tr id="timepicker-submit-tr"><td></td><td><i id="timepicker-submit" class="fa fa-check"></td><td></td></tr>');
		$('#timepicker-submit-tr').on('click', function(){
			$('#action_time').timepicker('hideWidget');
		});
	});
	$('#action_time').on('hide.timepicker', function(){
		$("#timepicker-submit-tr").remove();
	});

});
//ナビバーの現在位置の色を変える
$(function(){
	//アドレスを取得
	path = location.pathname;
	//アドレスによってタイムライン、マイページ、他人の行動に分けてナビバーの色を変える
	if(path.match("/actions")){
		if(path.split("/")[2] == <%= current_user.id %>){
			$("ul.nav li").eq(1).addClass("active");
			return;
		}else if(path.split("/")[2]){
			return;
		}
		$("ul.nav li").eq(0).addClass("active");
	}else if(path.match("/mypage")){
		$("ul.nav li").eq(1).addClass("active");
	}
});

//行動の記述をajaxで追加
$(function(){
	$("#prize_submit").click(function() {
		if( $("#action_where").val() == "" || $("#action_what").val() == "" || $("#action_date").val() == "" || $("#action_time").val() == ""){
			alert("入力していない項目があります");
			return;
		}else if($("#action_who").val() == $("#action_author").val()){
			alert("自分のことを褒めることは出来ません");
			return;
		}
		$.ajax({
			type: 'post',
			url: '/actions',
			data: {who : $("#action_who").val(),
					date: $("#action_date").val(),
					time: $("#action_time").val(),
					where: $("#action_where").val(),
					what: $("#action_what").val(),
					author: $("#action_author").val()
					},
			success: function(one_action){
				$('#prizeModal').modal('hide');
				$("#action_where").val("");
				$("#action_what").val("");
				$("#main-column").prepend(one_action);
			},
			error: function(){
				alert("通信エラー！もう少し時間をおいて試してみてください。");
				$('#prizeModal').modal('hide');
			}
		});
	});
});

//ページの下の方に行くと続きの行動をサーバーから取ってくる
$(function() {
	var loading = false;
	$('#more')// mainの一番下に配置
		.lazyload({ threshold: 200 })// 200px 余裕をもって appear イベントを発行
		.on('appear', function () {
			if (loading) return;// 非同期通信を抑制する
			loading = true;
			$.ajax({
				type: 'get',
				url: '<%= request.path_info %>',
				data: {act_time: $(".well:last").data("act_time")},
				success: function(actions){
					//取ってきたデータが空だとそれ以降はサーバーにアクセスしない
					if(actions != " "){
						$('#more').before(actions);
						loading = false;
					}
				},
				error: function(){
				}
			});
		});
});
</script>
